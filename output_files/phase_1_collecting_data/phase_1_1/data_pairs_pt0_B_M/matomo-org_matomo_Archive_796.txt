    /**
     * @param $archiveGroups
     * @param $site
     * @param $period
     */

    private function prepareArchive(array $archiveGroups, Site $site, Period $period)
    {
        $coreAdminHomeApi = API::getInstance();

        $requestedReport = null;
        if (SettingsServer::isArchivePhpTriggered()) {
            $requestedReport = Common::getRequestVar('requestedReport', '', 'string');
        }

        $periodString = $period->getRangeString();
        $periodDateStr = $period->getLabel() == 'range' ? $periodString : $period->getDateStart()->toString();

        $idSites = array($site->getId());

        // process for each plugin as well
        foreach ($archiveGroups as $plugin) {
            $doneFlag = $this->getDoneStringForPlugin($plugin, $idSites);
            $this->initializeArchiveIdCache($doneFlag);

            $prepareResult = $coreAdminHomeApi->archiveReports(
                $site->getId(), $period->getLabel(), $periodDateStr, $this->params->getSegment()->getOriginalString(),
                $plugin, $requestedReport);

            if (!empty($prepareResult)
                && !empty($prepareResult['idarchives'])
            ) {
                foreach ($prepareResult['idarchives'] as $idArchive) {
                    $this->idarchives[$doneFlag][$periodString][] = $idArchive;
                }
            }
        }
    }
